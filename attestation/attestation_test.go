package attestation

import (
	"encoding/hex"
	"slices"
	"testing"
)

func TestDetectReportType(t *testing.T) {
	type args struct {
		report string
	}
	tests := []struct {
		name    string
		args    args
		want    string
		wantErr bool
	}{
		{
			name: "sgx",
			args: args{
				report: "0100000002000000f811000000000000030002000000000009000e00939a7233f79c4ca9940a0db3957f0607091992f0b2fe1f77e2a4cfdfb2989a950000000012130a07ff80060000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000000000007000000000000005ac690ee17c61fd662defda61e2fa0497c700dc9c55728da5831c4beaa40e91a0000000000000000000000000000000000000000000000000000000000000000b43c017e8742d8354bd3bd043038c83f4f4ef2adae6886f5d6312b3e63d11ae10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020e6250e16b5fd0a35631367926d74f400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044100000f4b396e7e22fbbc94627500b44a992374501b9e4e02d49290caced10335854ffe28e19cbc337f8a37c7351cc6faa1c87f70459592d1019bc1c62efc9c756af744f6f22e7df564682a4d792727110e4b58fc4c339cf1ddfd095ebf5e27c44b6f4d3b20e6cf2d1bbef6146447d9889a3f546b456f63c63e2287d81e0109f47749712130a07ff8006000000000000000000000000000000000000000000000000000000000000000000000000000000000015000000000000000700000000000000192aa50ce1c0cef03ccf89e7b5b16b0d7978f5c2b1edcf774d87702e8154d8bf00000000000000000000000000000000000000000000000000000000000000008c4f5775d796503e96137f77c68a829a0056ac8ded70140b081b094490c57bff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021fc74c99a20efab881627a202e5ce17d4ba09a17dafed534fb71c5e70a73e3600000000000000000000000000000000000000000000000000000000000000005f0181f80786811cc9866b363f2ea33ea39ed496d2370b555cc296b3c7ac8d5e3e898f7d2fabcb9bcdb2b8c451a2b10ed6052b265a8a456fadd7cbd82066052f2000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f0500dc0d00002d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949456a54434342444f674177494241674955543769766d7331574e70517a6a5279395a774b6c30726f6f47326b77436759494b6f5a497a6a3045417749770a6354456a4d4345474131554541777761535735305a577767553064594946424453794251636d396a5a584e7a6233496751304578476a415942674e5642416f4d0a45556c756447567349454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155450a4341774351304578437a414a42674e5642415954416c56544d4234584454497a4d5445794d5445334e4449794d6c6f5844544d774d5445794d5445334e4449790a4d6c6f77634445694d434147413155454177775a535735305a5777675530645949464244537942445a584a3061575a70593246305a5445614d426747413155450a43677752535735305a577767513239796347397959585270623234784644415342674e564241634d43314e68626e526849454e7359584a684d517377435159440a5651514944414a445154454c4d416b474131554542684d4356564d775754415442676371686b6a4f5051494242676771686b6a4f50514d4242774e434141524d0a674c61744b695a58797232514c59686c4335706a516a76695862795a3352356a4a4737614f573962716c304b4e4742497455395950584a626d743570773771360a4e5738334a613755684a6a64674f4d47435644706f3449437144434341715177487759445652306a42426777466f4155304f6971326e58582b53354a463567380a6578526c304e587957553077624159445652306642475577597a42686f462b6758595a626148523063484d364c79396863476b7564484a316333526c5a484e6c0a636e5a705932567a4c6d6c75644756734c6d4e766253397a5a3367765932567964476c6d61574e6864476c76626939324e4339775932746a636d772f593245390a63484a765932567a633239794a6d56755932396b6157356e5057526c636a416442674e5648513445466751557a7332642f2f37486157704e6159493046664a500a667967686979497744675944565230504151482f42415144416762414d41774741315564457745422f7751434d4141776767485542676b71686b69472b4530420a44514545676748464d4949427754416542676f71686b69472b453042445145424242417852497448303433344d30315571623839707978704d4949425a41594b0a4b6f5a496876684e41513042416a4343415651774541594c4b6f5a496876684e4151304241674543415245774541594c4b6f5a496876684e41513042416749430a415245774541594c4b6f5a496876684e4151304241674d43415149774541594c4b6f5a496876684e4151304241675143415151774541594c4b6f5a496876684e0a4151304241675543415145774551594c4b6f5a496876684e4151304241675943416743414d42414743797147534962345451454e41514948416745474d4241470a43797147534962345451454e41514949416745414d42414743797147534962345451454e4151494a416745414d42414743797147534962345451454e4151494b0a416745414d42414743797147534962345451454e4151494c416745414d42414743797147534962345451454e4151494d416745414d42414743797147534962340a5451454e4151494e416745414d42414743797147534962345451454e4151494f416745414d42414743797147534962345451454e41514950416745414d4241470a43797147534962345451454e41514951416745414d42414743797147534962345451454e415149524167454c4d42384743797147534962345451454e415149530a4242415245514945415941474141414141414141414141414d42414743697147534962345451454e41514d45416741414d42514743697147534962345451454e0a4151514542674351627455414144415042676f71686b69472b45304244514546436745414d416f4743437147534d343942414d43413067414d455543495143590a674d766473303775722b67616d7035353653524f4f537836536d5678365665476356327a3032327667774967596b7436485765752b41737a624e3274454666480a6258674a4a4177515a75425a4d6f4743504b78547965453d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436d444343416a36674177494241674956414e446f71747031312f6b7553526559504873555a644456386c6c4e4d416f4743437147534d343942414d430a4d476778476a415942674e5642414d4d45556c756447567349464e48574342536232393049454e424d526f77474159445651514b4442464a626e526c624342440a62334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e564241674d416b4e424d5173770a435159445651514745774a56557a4165467730784f4441314d6a45784d4455774d5442614677307a4d7a41314d6a45784d4455774d5442614d484578497a41680a42674e5642414d4d476b6c756447567349464e48574342515130736755484a765932567a6332397949454e424d526f77474159445651514b4442464a626e526c0a6243424462334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e564241674d416b4e420a4d517377435159445651514745774a56557a425a4d424d4742797147534d34394167454743437147534d34394177454841304941424c39712b4e4d7032494f670a74646c31626b2f75575a352b5447516d38614369387a373866732b664b435133642b75447a586e56544154325a68444369667949754a77764e33774e427039690a484253534d4a4d4a72424f6a6762737767626777487759445652306a42426777466f4155496d554d316c71644e496e7a6737535655723951477a6b6e427177770a556759445652306642457377535442486f45576751345a426148523063484d364c79396a5a584a3061575a70593246305a584d7564484a316333526c5a484e6c0a636e5a705932567a4c6d6c75644756734c6d4e766253394a626e526c62464e4857464a76623352445153356b5a584977485159445652304f42425945464e446f0a71747031312f6b7553526559504873555a644456386c6c4e4d41344741315564447745422f77514541774942426a415342674e5648524d4241663845434441470a4151482f416745414d416f4743437147534d343942414d43413067414d4555434951434a6754627456714f795a316d336a716941584d365159613672357357530a34792f4737793875494a4778647749675271507642534b7a7a516167424c517135733541373070646f6961524a387a2f3075447a344e675639316b3d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436a7a4343416a53674177494241674955496d554d316c71644e496e7a6737535655723951477a6b6e42717777436759494b6f5a497a6a3045417749770a614445614d4267474131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e760a636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a0a42674e5642415954416c56544d423458445445344d4455794d5445774e4455784d466f58445451354d54497a4d54497a4e546b314f566f77614445614d4267470a4131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e76636e4276636d46300a615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a42674e56424159540a416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a3044415163445167414543366e45774d4449595a4f6a2f69505773437a61454b69370a314f694f534c52466857476a626e42564a66566e6b59347533496a6b4459594c304d784f346d717379596a6c42616c54565978465032734a424b357a6c4b4f420a757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f5363477244425342674e5648523845537a424a0a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b63325679646d6c6a5a584d75615735300a5a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e564851344546675155496d554d316c71644e496e7a673753560a55723951477a6b6e4271777744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159424166384341514577436759490a4b6f5a497a6a3045417749445351417752674968414f572f35516b522b533943695344634e6f6f774c7550524c735747662f59693747535839344267775477670a41694541344a306c72486f4d732b586f356f2f7358364f39515778485241765a55474f6452513763767152586171493d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a00",
			},
			want:    TEE_TYPE_SGX,
			wantErr: false,
		},
		{
			name: "nitro",
			args: args{
				report: "8444a1013822a059113aa9696d6f64756c655f69647827692d30326464306162653231356563656138392d656e633031393161323764346336643831373866646967657374665348413338346974696d657374616d701b00000191a27da3d86470637273b0005830fcc4ced3f4bba7352e289a27fb8fb7358255d6b35abafdc8b4a398c418a44779a377979baa62fc78ef6d89aa6bc11af00158300343b056cd8485ca7890ddd833476d78460aed2aa161548e4e26bedf321726696257d623e8805f3f605946b3d8b0c6aa02583055a296be86298ce7d58bf289bad529c70e0d50854b475990d4f8ead2bf02d6fb476e717cc80c057abf7cd0f21cdfc596035830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000045830696380e5b4d8619d91fc2dea57e715f34d7b02a240a020b11060de0d78bd13b5a8ce9ade6db7abb2d673d5deb295b2000558300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000658300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000758300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000858300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000958300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b63657274696669636174655902823082027e30820203a00302010202100191a27d4c6d81780000000066d18887300a06082a8648ce3d04030330818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30326464306162653231356563656138392e61702d736f7574682d322e6177732e6e6974726f2d656e636c61766573301e170d3234303833303038353332345a170d3234303833303131353332375a308194310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313f303d06035504030c36692d30326464306162653231356563656138392d656e63303139316132376434633664383137382e61702d736f7574682d322e6177733076301006072a8648ce3d020106052b810400220362000460bb464ec21a2398f69c504003e435628413c6e834791df9c31d7964f296432eb920095c98ee0a8b14972feb5e9a443c6395d42ec3390690d631b1418d5deda7ce6dc3c6377c8eab771804e822855c46a1a9785b968086fdd620511c5366cff6a31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100d3a9c2c8c7de6413540932af04d2d671a5a7d03e917559a409855d68b5e71eb8a1f3595a2d6218ff2628fac054e525ef023100cfe71c0524f38cd46a918a1343c09c0f8a41cadf804c5ade17ea6656fd8c58cba20670a124b84a5bcb487416b3384da868636162756e646c65845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c4308202c030820245a003020102021029d66f90c382851ea2057d49441df7e5300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3234303832353037313132355a170d3234303931343038313132355a3065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e373538313864653839373335323564392e61702d736f7574682d322e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fd8e2a9d9db649d21c2f347193c7054a9b5bf557725006990648d0916649d6236b129dae5f36817c98589e7a638cba5ec8c262420a8c64698efab355fd99df1fc974539b3e8eb30dcd790e20a7c253340cfa738b843efd1b7514381d24ccf8f1a381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e04160414e6b52c62c37c9caf2dce08926e351853443ca5b4300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d0403030369003066023100f11e8bfb4d3664a5b37dd2c7f76ed7306e67a50f73181244335a899d640aa9085d0e9278dd80be840b2b4a44aafd2889023100e0637cd280596f944f1df7e75cc7d25aa2275dfb49463b9976ef93f7d65e98d33ec55a4f942100f5b26139a199d63bcd59031c308203183082029fa003020102021100fe980e9a4e9e7f50d593a21a6d8ba4ef300a06082a8648ce3d0403033065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e373538313864653839373335323564392e61702d736f7574682d322e6177732e6e6974726f2d656e636c61766573301e170d3234303833303032323231385a170d3234303930353032323231385a30818a313d303b06035504030c34653436636435373936353562633163632e7a6f6e616c2e61702d736f7574682d322e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b8104002203620004138ecb1f7810ae4f93c3971604f7be8312ca970dcf246090b7c8572dc2528065f92951533dc2fe144337c723341585340569a95026bab33b841084aac82bdbb9d5f13fe8116a3bd24207bfd92db07363151416d59a8ce5d06cebe7be99ebd1d9a381ec3081e930120603551d130101ff040830060101ff020101301f0603551d23041830168014e6b52c62c37c9caf2dce08926e351853443ca5b4301d0603551d0e041604148ca669a8193c798158648478b783858e3078f43a300e0603551d0f0101ff0404030201863081820603551d1f047b30793077a075a0738671687474703a2f2f63726c2d61702d736f7574682d322d6177732d6e6974726f2d656e636c617665732e73332e61702d736f7574682d322e616d617a6f6e6177732e636f6d2f63726c2f33383936306365352d393734642d346433362d623264352d6431323638326365653938392e63726c300a06082a8648ce3d0403030367003064023018d9b61b0d682fd95e620751d6359805bd0bfd45971ebf2afd347b2c61a65e1915447424481c75d31fcd1ecc36091c9202307e2d584748450b163404788c1b37bc02b9530e3dea750df22064b20d0938efc710781200a4a690ae0fd5314466dbe1845902c4308202c030820247a003020102021500ca4e61b89ce72cc54b8c6115c3ab0568943c910e300a06082a8648ce3d04030330818a313d303b06035504030c34653436636435373936353562633163632e7a6f6e616c2e61702d736f7574682d322e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3234303833303037353331365a170d3234303833313037353331365a30818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30326464306162653231356563656138392e61702d736f7574682d322e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004a5a2a0e615200c7505cd990d4fccb4d7cd07038774a550c31bde915b2c274f5cb928f5d29a9a9ad6a1fe8e63b8b5bc667c11f7064d454a6cf0b0c4b375680a94bed5d725c6c937d017fbd966b775a9f5d8ac35dd4cd2fd9c336dce12b3096113a366306430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204301d0603551d0e04160414aceb4414a2a63884c3d8d49bcf42212ffdc68db3301f0603551d230418301680148ca669a8193c798158648478b783858e3078f43a300a06082a8648ce3d040303036700306402306d651cbaad03a94216368f53b6ff3be234e18b6434fbe792674d7febe4f7fa70abdb154f5e0070bc3b87157e531dd7ad02305ea32513456249049198f2059740ba9320c00ecb01fc6d50fe8662e1bab224816d8d39489e52df1010d692406eefa5ac6a7075626c69635f6b6579f669757365725f64617461505ff1546349b95228a63c50332fd3b46a656e6f6e63655820ccce43e57f1c44ba9d8ba70c9cd151672ef0f906e3b98aac45f66f9e5068636d58602b78fcc47370eabc7074636f9d224016a2ebb7b296ce77ac58391d6e72bccf26b346470063f3a3dbf41d0ecf16cac7135957b57e34d673ee900020abbb90c1978107d74bf95f835dfc5e6251442f0ad619070fc7c6ebf8f53d9271170d28c0fd",
			},
			want:    TEE_TYPE_NITRO,
			wantErr: false,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			reportBytes, err := hex.DecodeString(tt.args.report)
			if err != nil {
				t.Fatal(err)
			}

			got, normalized, err := DetectReportTypeNormalize(reportBytes)
			if (err != nil) != tt.wantErr {
				t.Errorf("DetectReportTypeNormalize() error = %v, wantErr %v", err, tt.wantErr)
				return
			}
			if got != tt.want {
				t.Errorf("DetectReportTypeNormalize() = %v, want %v", got, tt.want)
			}

			got2, normalized2, err := DetectReportTypeNormalize(normalized)
			if err != nil {
				t.Errorf("DetectReportTypeNormalize() error = %v, shouldn't fail when normalizing normalized report", err)
				return
			}

			if got != got2 {
				t.Errorf("DetectReportTypeNormalize() detected type shouldn't change when detecting type on normalized report, got raw = %v, got normalized = %v", got, got2)
			}

			if !slices.Equal(normalized, normalized2) {
				t.Error("DetectReportTypeNormalize() normalized report can be normalized only once but normalizing normalized report changed the result")
			}
		})
	}
}
